<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>1:1 ì±„íŒ…</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-auth-compat.js"></script>
  <style>
    body { background-color: #f5f5f5; }
    #chat-box {
      height: 500px; overflow-y: auto;
      background: white; border-radius: 10px; padding: 15px;
    }
    .msg { max-width: 70%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; word-wrap: break-word; }
    .me { background-color: #DCF8C6; }
    .other { background-color: #E5E5EA; }
  </style>
</head>
<body class="container py-4">

  <h4 class="mb-3">ğŸ’¬ 1:1 ëŒ€í™”ë°©</h4>
  <div id="chat-box"></div>

  <form id="chat-form" class="d-flex mt-3">
    <input type="text" id="messageInput" class="form-control me-2" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required>
    <button type="submit" class="btn btn-primary">ì „ì†¡</button>
  </form>

  <div class="d-flex gap-2 mt-3">
    <a href="index.html" class="btn btn-secondary">â† í™ˆìœ¼ë¡œ</a>
    <button id="deleteChatBtn" class="btn btn-danger">ğŸ—‘ï¸ ì±„íŒ…ë°© ì‚­ì œ</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBTKf-9U6yL8gNhvUCG2eMB5iF4Xc8GPtc",
      authDomain: "project-2ec77.firebaseapp.com",
      projectId: "project-2ec77",
      storageBucket: "project-2ec77.firebasestorage.app",
      messagingSenderId: "473929963915",
      appId: "1:473929963915:web:f05fed9103155df089778e",
      measurementId: "G-WFW07K42RQ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    let chatId = urlParams.get('id'); // URLì— chatIdê°€ ì—†ì„ ìˆ˜ë„ ìˆìŒ

    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const messageInput = document.getElementById("messageInput");
    const deleteChatBtn = document.getElementById("deleteChatBtn");

    let currentUser = null;
    let currentStudentId = null;
    let otherUid = null;

    function maskStudentId(id) {
      if (!id) return "ìµëª…";
      if (id.length <= 4) return "****";
      return id.slice(0, id.length - 4) + "****";
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        window.location.href = "login.html";
        return;
      }
      currentUser = user;

      const userDoc = await db.collection("users").doc(user.uid).get();
      if (userDoc.exists) {
        currentStudentId = userDoc.data().studentId;
      }

      // ìƒëŒ€ë°© UIDë¥¼ URLì—ì„œ ë°›ëŠ”ë‹¤ê³  ê°€ì • (ì˜ˆ: chat.html?other=ìƒëŒ€ë°©UID)
      otherUid = urlParams.get('other');

      // chatIdê°€ ì—†ìœ¼ë©´ participants ì¡°í•©ìœ¼ë¡œ ê¸°ì¡´ ë°© ê²€ìƒ‰ â†’ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
      if (!chatId && otherUid) {
        const existing = await db.collection("chats")
          .where("participants", "in", [[currentUser.uid, otherUid], [otherUid, currentUser.uid]])
          .get();

        if (!existing.empty) {
          chatId = existing.docs[0].id;
        } else {
          const newChat = await db.collection("chats").add({
            participants: [currentUser.uid, otherUid],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          chatId = newChat.id;
        }
        // URL ì—…ë°ì´íŠ¸
        window.history.replaceState(null, null, `?id=${chatId}`);
      }

      if (!chatId) {
        alert("ì±„íŒ…ë°© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        window.location.href = "index.html";
        return;
      }

      // ë‚´ unread ì´ˆê¸°í™”
      await db.collection("chats").doc(chatId).set({
        unread: { [user.uid]: false }
      }, { merge: true });

      // ë©”ì‹œì§€ êµ¬ë…
      db.collection("chats").doc(chatId).collection("messages")
        .orderBy("createdAt")
        .onSnapshot((snapshot) => {
          chatBox.innerHTML = "";
          snapshot.forEach((doc) => {
            const msg = doc.data();
            const wrapper = document.createElement("div");
            wrapper.className = "d-flex mb-2 " + (msg.sender === currentUser.uid ? "justify-content-end" : "justify-content-start");

            const bubble = document.createElement("div");
            bubble.className = "msg " + (msg.sender === currentUser.uid ? "me" : "other");
            bubble.innerText = msg.text || "(ë¹ˆ ë©”ì‹œì§€)";

            wrapper.appendChild(bubble);
            chatBox.appendChild(wrapper);
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        });

      // ë©”ì‹œì§€ ì „ì†¡
      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (text === "") return;

        await db.collection("chats").doc(chatId).collection("messages").add({
          text: text,
          sender: currentUser.uid,
          senderStudentId: currentStudentId || "ìµëª…",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await db.collection("chats").doc(chatId).set({
          lastMessage: text,
          lastSender: currentUser.uid,
          unread: {
            [currentUser.uid]: false,
            [otherUid]: true
          }
        }, { merge: true });

        messageInput.value = "";
      });

      // ì±„íŒ…ë°© ì‚­ì œ
      deleteChatBtn.addEventListener("click", async () => {
        const confirmDelete = confirm("ì±„íŒ…ë°©ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if (!confirmDelete) return;

        const messagesRef = db.collection("chats").doc(chatId).collection("messages");
        const messagesSnap = await messagesRef.get();
        const batch = db.batch();
        messagesSnap.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();

        await db.collection("chats").doc(chatId).delete();

        alert("ì±„íŒ…ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.href = "index.html";
      });
    });
  </script>
</body>
</html>
